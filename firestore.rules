rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- დამხმარე ფუნქციები ---
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidOrderCreation() {
      let data = request.resource.data;
      return
        data.keys().hasAll(['items', 'totalAmount', 'orderStatus', 'customerInfo']) &&
        data.items.size() > 0 &&
        data.totalAmount > 0 &&
        data.orderStatus == 'pending' &&
        data.customerInfo.keys().hasAll(['firstName']) &&
        (
           !data.customerInfo.keys().hasAny(['email']) ||
           data.customerInfo.email is string
        );
    }

    // --- კოლექციები ---

    // 1. Users
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // 2. Products - ✅ 100% ოპტიმიზებული
    match /products/{productId} {
      allow read: if true;

      // შექმნა და წაშლა მხოლოდ ადმინს
      allow create, delete: if isAdmin();

      // განახლება (Stock Update):
      // დაშვებულია ყველასთვის (სტუმრებისთვისაც), მაგრამ მკაცრი პირობებით
      allow update: if
        isAdmin() ||
        (
          // 1. იცვლება მხოლოდ stock და updatedAt
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stock', 'updatedAt']) &&
          // 2. stock არის რიცხვი
          request.resource.data.stock is number &&
          // 3. stock არ ჩადის მინუსში
          request.resource.data.stock >= 0 &&
          // 4. ⚠️ მარაგი აუცილებლად უნდა შემცირდეს (დაცვა მომატებისგან)
          request.resource.data.stock < resource.data.stock
        );
    }

    // 3. Orders
    match /orders/{orderId} {
      allow create: if
        isAdmin() ||
        (
          isValidOrderCreation() &&
          (
            (isAuthenticated() && request.resource.data.userId == request.auth.uid) ||
            (!isAuthenticated() &&
             request.resource.data.userId == null &&
             request.resource.data.customerInfo.isGuest == true)
          )
        );

      // 🔧 ORDER READ PERMISSIONS - Enhanced for success page access
      allow read: if
        isAdmin() ||
        // Owner access (authenticated users for their own orders)
        (isAuthenticated() && resource.data.userId == request.auth.uid) ||
        // Guest access (unauthenticated users for guest orders)
        (!isAuthenticated() &&
         resource.data.userId == null &&
         resource.data.customerInfo.isGuest == true) ||
        // 🆕 SUCCESS PAGE ACCESS: Allow reading any order for payment confirmation
        // This enables both logged-in and logged-out users to view orders on success page
        (resource.data.orderStatus in ['pending', 'confirmed', 'paid'] &&
         resource.data.paymentStatus in ['pending', 'paid']);

      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // 4. Carts (ძველი)
    match /carts/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // 5. userCarts (რაც კოდშია!) - ✅ ადმინიც დავამატეთ
    match /userCarts/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // 6. Mail
    match /mail/{emailId} {
      allow create: if true;
      allow read: if false;
    }
  }
}